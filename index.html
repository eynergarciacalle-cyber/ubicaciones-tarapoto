<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de BÃºsqueda Tarapoto</title>
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Tesseract -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!-- html5-qrcode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- web19 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient-start: #020617;
            --bg-gradient-mid: #0f172a;
            --bg-gradient-end: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.5);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --accent-color: #38bdf8;
            --border-color: #334155;
            --input-bg: rgba(15, 23, 42, 0.7);
            --table-header-bg: rgba(30, 41, 59, 0.8);
            --row-hover-bg: rgba(51, 65, 85, 0.5);
            --card-border: rgba(255, 255, 255, 0.1);
        }

        body.light-theme {
            --bg-gradient-start: #f1f5f9;
            --bg-gradient-mid: #e2e8f0;
            --bg-gradient-end: #cbd5e1;
            --card-bg: rgba(255, 255, 255, 0.6);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --accent-color: #0284c7;
            --border-color: #cbd5e1;
            --input-bg: rgba(241, 245, 249, 0.7);
            --table-header-bg: rgba(226, 232, 240, 0.8);
            --row-hover-bg: rgba(203, 213, 225, 0.5);
            --card-border: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: Poppins, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-mid), var(--bg-gradient-end));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-primary);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(-5px);
        }

        .card-compact {
            padding: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-3px);
            scale: 1.05;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-primary { background: linear-gradient(45deg, #2563eb, #3b82f6); color: #fff; }
        .btn-secondary { background: linear-gradient(45deg, #059669, #10b981); color: #fff; }
        .btn-tertiary { background: linear-gradient(45deg, #5b21b6, #6d28d9); color: #fff; }
        .btn-danger { background: linear-gradient(45deg, #dc2626, #ef4444); color: #fff; }
        .btn-gray { background: linear-gradient(45deg, #4b5563, #6b7280); color: #fff; }
        .btn-qr { background: linear-gradient(45deg, #7c3aed, #a855f7); color: #fff; padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-qr:hover { background: linear-gradient(45deg, #9333ea, #c084fc); }

        textarea, input[type="text"] {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.5rem;
            transition: all 0.3s;
        }

        textarea::placeholder, input[type="text"]::placeholder {
            color: var(--text-secondary);
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3);
        }

        .results-scroll-wrapper {
            max-height: 550px;
            overflow-y: auto;
        }

        .printableArea th {
            background-color: var(--table-header-bg);
            color: var(--accent-color);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
        }

        .printableArea td {
            border-color: var(--border-color);
            transition: background-color 0.3s;
        }

        .printableArea tr:hover td {
            background-color: var(--row-hover-bg);
        }

        .print-only { display: none; }

        @media print {
            body { background: #fff !important; }
            body { visibility: hidden; }
            .printableArea, .printableArea * { visibility: visible; }
            .printableArea { color: #000 !important; position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .print-only { display: block !important; background: #fff !important; color: #000 !important; }
            .results-scroll-wrapper { max-height: none !important; overflow-y: visible !important; }
            .printableArea table, .printableArea th, .printableArea td { border-color: #999 !important; font-size: 9pt !important; padding: 2px 4px !important; }
            .printableArea th { background: #eee !important; }
        }

        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
        }

        .qr-modal-content {
            background: var(--card-bg);
            margin: 4% auto;
            padding: 16px;
            border: 1px solid var(--border-color);
            width: 95%;
            max-width: 480px;
            border-radius: 0.75rem;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8 no-print relative">
            <h1 class="text-3xl sm:text-4xl font-bold tracking-wider">Gestor de BÃºsqueda Tarapoto</h1>
            <p class="mt-2">Carga, convierte imÃ¡genes, busca, actualiza y guarda tus datos de inventario.</p>
            <div class="absolute top-0 right-0">
                <button id="themeToggleBtn" class="p-2 rounded-full bg-slate-700/50 hover:bg-slate-600/50">
                    <svg id="themeIconSun" class="h-6 w-6 text-yellow-300 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M12 5a7 7 0 100 14 7 7 0 000-14z"></path>
                    </svg>
                    <svg id="themeIconMoon" class="h-6 w-6 text-slate-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main class="space-y-6 no-print">
            <!-- 1. Cargar Hojas (Minimizado) -->
            <div class="card card-compact">
                <div id="dataLoaderToggler" class="flex justify-between items-center cursor-pointer px-2 py-1 hover:bg-slate-700/30 rounded transition-colors">
                    <h2 class="text-sm font-semibold">ðŸ“Š Cargar Datos</h2>
                    <svg id="dataLoaderChevron" class="h-5 w-5 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="dataLoaderContent" class="hidden mt-2 border-t border-slate-700 pt-4">
                    <div class="space-y-4">
                        <!-- DB1 -->
                        <div class="flex items-center gap-4 p-2 rounded-lg hover:bg-slate-800/50">
                            <div class="flex-shrink-0 w-10 h-10 bg-slate-700 text-blue-400 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-semibold">Base de Datos 1 (Descripciones)</h3>
                                <p id="status1" class="text-sm">Sincronizando DB1...</p>
                            </div>
                            <label for="file1" class="btn btn-primary text-sm py-2 px-4 cursor-pointer">
                                <span>Seleccionar</span>
                            </label>
                            <input type="file" id="file1" accept=".xlsx,.xls" class="hidden">
                        </div>

                        <!-- DB2 -->
                        <div class="flex items-center gap-4 p-2 rounded-lg hover:bg-slate-800/50">
                            <div class="flex-shrink-0 w-10 h-10 bg-slate-700 text-green-400 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-grow">
                                <h3 class="font-semibold">Base de Datos 2 (Ubicaciones)</h3>
                                <p id="status2" class="text-sm">Sincronizando DB2...</p>
                            </div>
                            <label for="file2" class="btn btn-secondary text-sm py-2 px-4 cursor-pointer">
                                <span>Seleccionar</span>
                            </label>
                            <input type="file" id="file2" accept=".xlsx,.xls" class="hidden">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. OCR -->
            <div class="card">
                <div id="ocrToggler" class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-2xl font-semibold">2. Convertir Imagen a Texto (OCR)</h2>
                    <svg id="ocrChevron" class="h-6 w-6 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="ocrContent" class="hidden mt-4 border-t border-slate-700 pt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                        <!-- CÃ³digos OCR -->
                        <div id="paste-area-codes" class="space-y-2">
                            <h3 class="font-medium">A. Extraer CÃ³digos</h3>
                            <label for="ocrInputCodes" class="btn btn-tertiary w-full text-sm py-2 cursor-pointer">
                                <span>Seleccionar Archivo de CÃ³digos</span>
                            </label>
                            <p class="text-xs text-center">O pegue la imagen en esta secciÃ³n</p>
                            <input type="file" id="ocrInputCodes" accept="image/*" class="hidden">
                            <p id="ocrStatusCodes" class="text-sm text-center">...</p>
                            <textarea id="ocrOutput" rows="4" class="w-full p-2" placeholder="CÃ³digos extrados..."></textarea>
                            <button id="clearOcrOutputBtn" class="btn btn-danger w-full text-sm py-2"><span>Limpiar CÃ³digos</span></button>
                        </div>

                        <!-- Cantidades OCR -->
                        <div id="paste-area-quantities" class="space-y-2">
                            <h3 class="font-medium">B. Extraer Cantidades</h3>
                            <label for="ocrInputQuantities" class="btn btn-tertiary w-full text-sm py-2 cursor-pointer">
                                <span>Seleccionar Archivo de Cantidades</span>
                            </label>
                            <p class="text-xs text-center">O pegue la imagen en esta secciÃ³n</p>
                            <input type="file" id="ocrInputQuantities" accept="image/*" class="hidden">
                            <p id="ocrStatusQuantities" class="text-sm text-center">...</p>
                            <textarea id="quantityInput" rows="4" class="w-full p-2" placeholder="Cantidades extradas..."></textarea>
                            <button id="clearQuantityInputBtn" class="btn btn-danger w-full text-sm py-2"><span>Limpiar Cantidades</span></button>
                        </div>
                    </div>
                    <div class="mt-4 border-t border-slate-700 pt-4">
                        <button id="generateReportBtn" class="btn btn-primary w-full"><span>Generar Reporte con Datos Convertidos</span></button>
                    </div>
                </div>
            </div>

            <!-- 3. BÃºsqueda manual -->
            <div class="card">
                <div id="bulkSearchToggler" class="flex justify-between items-center cursor-pointer">
                    <h2 class="text-2xl font-semibold">3. BÃºsqueda Manual</h2>
                    <svg id="bulkSearchChevron" class="h-6 w-6 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div id="bulkSearchContent" class="mt-4 border-t border-slate-700 pt-4">
                    <div>
                        <div class="flex justify-between items-center mb-2 gap-2">
                            <label for="bulkSearchInput" class="block font-medium">Pegue los cÃ³digos aquÃ­, uno por lÃ­nea</label>
                            <div class="flex gap-2">
                                <button id="clearBulkSearchBtn" class="btn btn-danger px-3 py-1 text-sm"><span>Limpiar</span></button>
                                <button id="scanBulkQRBtn" class="btn btn-qr text-sm">QR</button>
                            </div>
                        </div>
                        <textarea id="bulkSearchInput" rows="8" class="w-full p-3"></textarea>
                    </div>
                </div>
            </div>
        </main>

        <!-- Ãrea imprimible -->
        <div id="printableArea" class="p-8">
            <h1 id="printTitle" class="text-2xl font-bold mb-6 text-center"></h1>
            <div id="bulkResultsOutput"></div>
        </div>

        <div class="flex justify-end mt-8 no-print gap-4">
            <button id="clearReportBtn" class="btn btn-gray hidden"><span>Limpiar Reportes</span></button>
            <button id="saveOnlyButton" class="btn btn-tertiary hidden disabled"><span>Guardar Cambios Localmente</span></button>
            <button id="syncAllToCloudBtn" class="btn bg-indigo-600 hover:bg-indigo-700 text-white hidden"><span>Sincronizar Todo a la Nube</span></button>
            <button id="saveButton" class="btn btn-primary hidden disabled"><span>Descargar Excel con Cambios</span></button>
            <button id="printButton" class="btn btn-secondary hidden"><span>Imprimir Listas</span></button>
        </div>
    </div>

    <footer class="text-center p-6 mt-8 no-print bg-slate-200/30 rounded-lg border border-slate-300/50 backdrop-filter backdrop-blur-sm">
        <p class="text-xs text-slate-600">Created by</p>
        <p class="text-sm font-semibold text-slate-700">Eyner Garcia</p>
        <p class="text-xs text-slate-600">Â© 2026</p>
    </footer>

    <!-- Modal QR -->
    <div id="qrModal" class="qr-modal no-print">
        <div class="qr-modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3 id="qrModalTitle" class="text-lg font-semibold">Escanear QR</h3>
            </div>
            <div id="qrReader" style="width: 100%"></div>
            <p id="qrStatus" class="text-sm text-center mt-2">Enfoca el cÃ³digo QR.</p>
            <div class="flex justify-center gap-2 mt-3">
                <button id="qrCloseBtn" class="btn btn-secondary text-sm">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        const URLGOOGLE = "https://script.google.com/macros/s/AKfycbxFiLtfAy4XuAFxy6P6C0AO5ONSs3ZpTdSa-N4cl9M7JMGC-TU72QiQ5_VygzIRh6A/exec";
        
        let data1 = [];
        let data2 = [];
        let db2filename = "basededatosactualizada.xlsx";

        const fileInput1 = document.getElementById("file1");
        const fileInput2 = document.getElementById("file2");
        const status1 = document.getElementById("status1");
        const status2 = document.getElementById("status2");
        const saveButton = document.getElementById("saveButton");
        const saveOnlyButton = document.getElementById("saveOnlyButton");
        const bulkSearchInput = document.getElementById("bulkSearchInput");
        const printableArea = document.getElementById("printableArea");
        const bulkResultsOutput = document.getElementById("bulkResultsOutput");
        const printButton = document.getElementById("printButton");
        const printTitle = document.getElementById("printTitle");
        const dataLoaderToggler = document.getElementById("dataLoaderToggler");
        const dataLoaderContent = document.getElementById("dataLoaderContent");
        const dataLoaderChevron = document.getElementById("dataLoaderChevron");
        const ocrToggler = document.getElementById("ocrToggler");
        const ocrContent = document.getElementById("ocrContent");
        const ocrChevron = document.getElementById("ocrChevron");
        const bulkSearchToggler = document.getElementById("bulkSearchToggler");
        const bulkSearchContent = document.getElementById("bulkSearchContent");
        const bulkSearchChevron = document.getElementById("bulkSearchChevron");
        const ocrInputCodes = document.getElementById("ocrInputCodes");
        const ocrInputQuantities = document.getElementById("ocrInputQuantities");
        const ocrStatusCodes = document.getElementById("ocrStatusCodes");
        const ocrStatusQuantities = document.getElementById("ocrStatusQuantities");
        const ocrOutput = document.getElementById("ocrOutput");
        const quantityInput = document.getElementById("quantityInput");
        const clearOcrOutputBtn = document.getElementById("clearOcrOutputBtn");
        const clearQuantityInputBtn = document.getElementById("clearQuantityInputBtn");
        const generateReportBtn = document.getElementById("generateReportBtn");
        const pasteAreaCodes = document.getElementById("paste-area-codes");
        const pasteAreaQuantities = document.getElementById("paste-area-quantities");
        const clearBulkSearchBtn = document.getElementById("clearBulkSearchBtn");
        const clearReportBtn = document.getElementById("clearReportBtn");
        const themeToggleBtn = document.getElementById("themeToggleBtn");
        const themeIconSun = document.getElementById("themeIconSun");
        const themeIconMoon = document.getElementById("themeIconMoon");
        const body = document.body;
        const syncAllToCloudBtn = document.getElementById("syncAllToCloudBtn");

        // Tema
        const applyTheme = (theme) => {
            if (theme === "light") {
                body.classList.add("light-theme");
                themeIconSun.classList.remove("hidden");
                themeIconMoon.classList.add("hidden");
            } else {
                body.classList.remove("light-theme");
                themeIconSun.classList.add("hidden");
                themeIconMoon.classList.remove("hidden");
            }
        };

        themeToggleBtn.addEventListener("click", () => {
            const isLight = body.classList.contains("light-theme");
            const newTheme = isLight ? "dark" : "light";
            localStorage.setItem("theme", newTheme);
            applyTheme(newTheme);
        });

        applyTheme(localStorage.getItem("theme") || "dark");

        function persistData2() {
            if (data2.length > 0) {
                localStorage.setItem("db2data", JSON.stringify(data2));
                localStorage.setItem("db2filename", "basededatosactualizada.xlsx");
                saveButton.disabled = false;
                saveOnlyButton.disabled = false;
                saveButton.classList.remove("hidden");
                saveOnlyButton.classList.remove("hidden");
            }
        }

        async function syncToCloud(itemEditado) {
            try {
                await fetch(URLGOOGLE, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(itemEditado)
                });
                console.log("Sincronizado item:", itemEditado.codigo);
                return true;
            } catch (error) {
                console.error("Error de red:", error);
                localStorage.setItem("pendingsync", true);
                return false;
            }
        }

        function handleFile(event, dataTarget, statusElement, fileNumber) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                dataTarget.length = 0;
                const uniqueCodes = new Map();

                for (let i = 1; i < json.length; i++) {
                    const row = json[i];
                    if (!row || row[0] == null) continue;

                    const codigo = String(row[0]).trim();
                    let entry = {
                        codigo: codigo,
                        descripcion: row[1],
                        undm: row[2]
                    };

                    if (fileNumber === 2) {
                        entry.ubicacion = row[3];
                    }

                    uniqueCodes.set(codigo.toLowerCase(), entry);
                }

                dataTarget.push(...uniqueCodes.values());
                localStorage.setItem(`db${fileNumber}data`, JSON.stringify(dataTarget));

                if (fileNumber === 2) {
                    db2filename = file.name;
                    persistData2();
                }

                statusElement.textContent = `${file.name} cargado con ${dataTarget.length} registros Ãºnicos.`;
                statusElement.classList.remove("text-slate-400");
                statusElement.classList.add("text-green-400", "font-semibold");

                if (bulkSearchInput.value.trim()) {
                    generateReport(bulkSearchInput.value);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        fileInput1.addEventListener("change", (e) => handleFile(e, data1, status1, 1));
        fileInput2.addEventListener("change", (e) => handleFile(e, data2, status2, 2));

        dataLoaderToggler.addEventListener("click", () => {
            dataLoaderContent.classList.toggle("hidden");
            dataLoaderChevron.classList.toggle("rotate-180");
        });

        ocrToggler.addEventListener("click", () => {
            ocrContent.classList.toggle("hidden");
            ocrChevron.classList.toggle("rotate-180");
        });

        bulkSearchToggler.addEventListener("click", () => {
            bulkSearchContent.classList.toggle("hidden");
            bulkSearchChevron.classList.toggle("rotate-180");
        });

        // OCR Functions
        async function processImageForOCR(file, outputTextarea, statusElement, inputElement = null) {
            if (!file) {
                statusElement.textContent = "No se proporcionÃ³ una imagen vÃ¡lida.";
                statusElement.classList.add("text-red-500");
                return;
            }

            statusElement.textContent = "Procesando imagen...";
            statusElement.classList.remove("text-red-500", "text-gray-500", "text-green-400");
            statusElement.classList.add("text-sky-400");

            try {
                const data = await Tesseract.recognize(file, "eng+spa", {
                    logger: m => {
                        if (m.status === "recognizing") {
                            statusElement.textContent = `Reconociendo... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                });

                const text = data.data.text;
                const existing = outputTextarea.value.trim();
                const newText = text.trim();

                outputTextarea.value = existing ? existing + "\n" + newText : newText;
                outputTextarea.scrollTop = outputTextarea.scrollHeight;
                outputTextarea.focus();
                outputTextarea.selectionStart = outputTextarea.value.length;
                outputTextarea.selectionEnd = outputTextarea.value.length;

                statusElement.textContent = "Â¡Ã‰xito! Datos agregados.";
                statusElement.classList.remove("text-sky-400");
                statusElement.classList.add("text-green-400");
            } catch(err) {
                console.error(err);
                statusElement.textContent = "OcurriÃ³ un error en la conversiÃ³n.";
                statusElement.classList.remove("text-sky-400");
                statusElement.classList.add("text-red-500");
            } finally {
                if (inputElement) inputElement.value = "";
            }
        }

        ocrInputCodes.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) processImageForOCR(file, ocrOutput, ocrStatusCodes, e.target);
        });

        ocrInputQuantities.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) processImageForOCR(file, quantityInput, ocrStatusQuantities, e.target);
        });

        function handlePaste(event, outputTextarea, statusElement) {
            const items = event.clipboardData || event.originalEvent.clipboardData;
            let img = null;

            for (let i = 0; i < items.items.length; i++) {
                if (items.items[i].type.indexOf("image") !== -1) {
                    img = items.items[i].getAsFile();
                    break;
                }
            }

            if (img) {
                event.preventDefault();
                statusElement.textContent = "Imagen pegada. Procesando...";
                processImageForOCR(img, outputTextarea, statusElement);
            }
        }

        pasteAreaCodes.addEventListener("paste", (e) => handlePaste(e, ocrOutput, ocrStatusCodes));
        pasteAreaQuantities.addEventListener("paste", (e) => handlePaste(e, quantityInput, ocrStatusQuantities));

        clearOcrOutputBtn.addEventListener("click", () => { ocrOutput.value = ""; });
        clearQuantityInputBtn.addEventListener("click", () => { quantityInput.value = ""; });

        generateReportBtn.addEventListener("click", () => {
            const codes = ocrOutput.value;
            if (!codes.trim()) {
                alert("No hay cÃ³digos extrados para generar el reporte.");
                return;
            }
            bulkSearchInput.value = codes;
            generateReport(codes);
        });

        function updateLocation(code, newLocation) {
            const codeToFind = String(code).trim().toLowerCase();
            let idx = data2.findIndex(i => String(i.codigo).trim().toLowerCase() === codeToFind);

            if (idx !== -1) {
                data2[idx].ubicacion = newLocation;
            } else {
                const item1 = data1.find(i => String(i.codigo).trim().toLowerCase() === codeToFind);
                data2.push({
                    codigo: code,
                    descripcion: item1 ? item1.descripcion : "",
                    undm: item1 ? item1.undm : "",
                    ubicacion: newLocation
                });
            }

            persistData2();
            return true;
        }

        function generateReport(codesString) {
            const codes = codesString.trim().split("\n").filter(c => c.trim());

            if (!codes.length) {
                printTitle.textContent = "";
                bulkResultsOutput.innerHTML = "";
                printButton.classList.add("hidden");
                clearReportBtn.classList.add("hidden");
                return;
            }

            let html = `<div class="results-scroll-wrapper"><table class="w-full text-left border-collapse">
                <thead>
                    <tr>
                        <th class="border border-slate-600 p-2 font-semibold">CÃ³digo</th>
                        <th class="border border-slate-600 p-2 font-semibold">DescripciÃ³n</th>
                        <th class="border border-slate-600 p-2 font-semibold">Unidad</th>
                        <th class="border border-slate-600 p-2 font-semibold">UbicaciÃ³n</th>
                    </tr>
                </thead>
                <tbody>`;

            codes.forEach((code, idx) => {
                const clean = code.trim();
                if (!clean) return;

                const norm = clean.toLowerCase();
                const item1 = data1.find(i => String(i.codigo).trim().toLowerCase() === norm);
                const item2 = data2.find(i => String(i.codigo).trim().toLowerCase() === norm);
                const uniqueId = `row-${norm}-${idx}`;

                if (!item1 && !item2) {
                    const codeCell = `<div class="no-print"><input type="text" value="${clean}" class="code-input w-full p-1 border border-transparent focus:border-slate-600 rounded-md bg-transparent"></div><span class="print-only">${clean}</span>`;
                    html += `<tr class="bg-red-900/20">
                        <td class="border border-slate-700 p-2">${codeCell}</td>
                        <td class="border border-slate-700 p-2" colspan="3"><span class="text-red-400 font-medium">CÃ³digo no encontrado en ninguna base.</span></td>
                        <td class="border border-slate-700 p-2"><span class="text-red-400">NA</span></td>
                    </tr>`;
                    return;
                }

                const desc = item1 ? item1.descripcion : item2.descripcion;
                const undm = item1 ? item1.undm : item2.undm;
                const loc = item2 ? item2.ubicacion : "";

                const codeCell = `<div class="no-print"><input type="text" value="${clean}" class="code-input w-full p-1 border border-transparent focus:border-slate-600 rounded-md bg-transparent"></div><span class="print-only">${clean}</span>`;
                const locCell = `<div class="no-print flex flex-col sm:flex-row gap-2 items-stretch">
                    <div class="flex-grow flex items-center gap-1">
                        <input type="text" value="${loc}" data-code="${clean}" data-qr-target="${uniqueId}" class="flex-grow p-2">
                        <button class="qr-location-btn btn btn-qr text-sm" data-qr-target="${uniqueId}" title="Escanear QR para ubicaciÃ³n">QR</button>
                    </div>
                    <button class="bulk-save-btn btn btn-secondary text-sm" data-code="${clean}"><span>Guardar</span></button>
                </div><span class="print-only">${loc}</span>`;

                html += `<tr>
                    <td class="border border-slate-700 p-2">${codeCell}</td>
                    <td class="border border-slate-700 p-2">${desc}</td>
                    <td class="border border-slate-700 p-2">${undm}</td>
                    <td class="border border-slate-700 p-2">${locCell}</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;

            const fecha = new Date().toLocaleDateString("es-ES", { year: "numeric", month: "long", day: "numeric" });
            printTitle.textContent = `Reporte de Ubicaciones - ${fecha}`;
            bulkResultsOutput.innerHTML = html;
            wireLocationQRButtons();
            wireLocationInputsAutoSave();

            const sw = bulkResultsOutput.querySelector(".results-scroll-wrapper");
            if (sw) sw.scrollTop = sw.scrollHeight;

            printButton.classList.remove("hidden");
            clearReportBtn.classList.remove("hidden");
            printableArea.scrollIntoView({ behavior: "smooth" });
        }

        function wireLocationInputsAutoSave() {
            document.querySelectorAll("input[data-code]").forEach(input => {
                let lastValue = input.value.trim();
                input.addEventListener("blur", () => {
                    const newValue = input.value.trim();
                    if (newValue === lastValue) return;

                    const code = input.getAttribute("data-code");
                    if (!newValue) return;

                    const ok = updateLocation(code, newValue);
                    if (ok) {
                        lastValue = newValue;
                    } else {
                        alert(`No se pudo guardar la ubicaciÃ³n para el cÃ³digo ${code}`);
                    }
                });
            });
        }

        bulkSearchInput.addEventListener("input", () => generateReport(bulkSearchInput.value));
        bulkSearchInput.addEventListener("paste", () => {
            setTimeout(() => {
                if (bulkSearchInput.value.trim() && !bulkSearchInput.value.endsWith("\n")) {
                    bulkSearchInput.value += "\n";
                }
                bulkSearchInput.scrollTop = bulkSearchInput.scrollHeight;
            }, 0);
        });

        printableArea.addEventListener("click", async (e) => {
            const btn = e.target.closest(".bulk-save-btn");
            if (!btn) return;

            const code = btn.dataset.code;
            const row = btn.closest("tr");
            const input = row.querySelector("input[data-code]");
            const newLoc = input.value.trim();

            if (!newLoc) {
                alert("Ingrese ubicaciÃ³n");
                return;
            }

            const item1 = data1.find(i => String(i.codigo).trim().toLowerCase() === code.toLowerCase());
            const item2 = data2.find(i => String(i.codigo).trim().toLowerCase() === code.toLowerCase());

            const datos = {
                codigo: code,
                descripcion: item1 ? item1.descripcion : (item2 ? item2.descripcion : ""),
                undm: item1 ? item1.undm : (item2 ? item2.undm : ""),
                ubicacion: newLoc
            };

            updateLocation(code, newLoc);
            const ok = await syncToCloud(datos);

            const origText = btn.innerHTML;
            btn.innerHTML = "<span>Â¡Listo!</span>";
            btn.classList.add("bg-green-600");
            setTimeout(() => {
                btn.innerHTML = origText;
                btn.classList.remove("bg-green-600");
            }, 2000);
        });

        function clearManualSearchAndReport() {
            bulkSearchInput.value = "";
            bulkResultsOutput.innerHTML = "";
            printTitle.textContent = "";
            printButton.classList.add("hidden");
            clearReportBtn.classList.add("hidden");
        }

        clearBulkSearchBtn.addEventListener("click", clearManualSearchAndReport);
        clearReportBtn.addEventListener("click", clearManualSearchAndReport);

        saveButton.addEventListener("click", () => {
            if (!data2.length) {
                alert("No hay datos en la Base de Datos 2 para guardar.");
                return;
            }

            const wsdata = [["CODIGO", "DESCRIPCION", "UNDM", "UBICACION"]];
            data2.forEach(i => wsdata.push([i.codigo, i.descripcion, i.undm, i.ubicacion]));

            const ws = XLSX.utils.aoa_to_sheet(wsdata);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "DB2 Actualizada");
            XLSX.writeFile(wb, "basededatosactualizada.xlsx");
        });

        saveOnlyButton.addEventListener("click", () => {
            if (!data2.length) {
                alert("No hay datos en la Base de Datos 2 para guardar.");
                return;
            }

            localStorage.setItem("db2data", JSON.stringify(data2));
            localStorage.setItem("db2filename", "basededatosactualizada.xlsx");

            const original = saveOnlyButton.innerHTML;
            saveOnlyButton.innerHTML = "<span>Â¡Guardado localmente!</span>";
            saveOnlyButton.disabled = true;
            setTimeout(() => {
                saveOnlyButton.innerHTML = original;
                saveOnlyButton.disabled = false;
            }, 1200);
        });

        printButton.addEventListener("click", () => window.print());

        window.addEventListener("load", async () => {
            status1.textContent = "Sincronizando DB1...";
            status2.textContent = "Sincronizando DB2...";

            try {
                const res = await fetch(URLGOOGLE);
                const json = await res.json();

                // Cargar DB1
                if (json.maestro && json.maestro.length > 1) {
                    data1 = json.maestro.slice(1).map(f => ({
                        codigo: String(f[0]).trim(),
                        descripcion: f[1],
                        undm: f[2]
                    }));
                    localStorage.setItem("db1data", JSON.stringify(data1));
                    status1.textContent = "âœ“ DB1 Sincronizada desde la nube.";
                    status1.className = "text-sm text-green-400 font-bold";
                } else {
                    status1.textContent = "No se encontrÃ³ DB1 en la nube.";
                    status1.className = "text-sm text-red-400 font-bold";
                }

                // Cargar DB2
                if (json.ubicaciones && json.ubicaciones.length > 1) {
                    data2 = json.ubicaciones.slice(1).map(f => ({
                        codigo: String(f[0]).trim(),
                        descripcion: f[1],
                        undm: f[2],
                        ubicacion: f[3]
                    }));
                    localStorage.setItem("db2data", JSON.stringify(data2));
                    status2.textContent = "âœ“ DB2 Sincronizada desde la nube.";
                    status2.className = "text-sm text-green-400 font-bold";
                    saveButton.classList.remove("hidden");
                    saveOnlyButton.classList.remove("hidden");
                    syncAllToCloudBtn.classList.remove("hidden");
                    saveButton.disabled = false;
                } else {
                    status2.textContent = "DB2 vacÃ­a en la nube. Carga un archivo Excel.";
                    status2.className = "text-sm text-yellow-400 font-bold";
                }
            } catch (e) {
                console.error("Error cargando desde nube:", e);

                // Intentar cargar desde localStorage
                const local1 = localStorage.getItem("db1data");
                if (local1) data1 = JSON.parse(local1);

                const local2 = localStorage.getItem("db2data");
                if (local2) data2 = JSON.parse(local2);

                status1.textContent = "âš  Cargada copia local (Offline).";
                status1.className = "text-sm text-yellow-400 font-bold";
                status2.textContent = "âš  Cargada copia local (Offline).";
                status2.className = "text-sm text-yellow-400 font-bold";
            }
        });

        // QR
        const qrModal = document.getElementById("qrModal");
        const qrStatus = document.getElementById("qrStatus");
        const qrCloseBtn = document.getElementById("qrCloseBtn");
        const scanBulkQRBtn = document.getElementById("scanBulkQRBtn");
        let qrTarget = null;
        let html5Qr = null;

        function handleQRValue(value) {
            if (!value) return;
            bulkSearchInput.value += (bulkSearchInput.value.trim() ? "\n" : "") + value;
            bulkSearchInput.focus();
            generateReport(bulkSearchInput.value);
        }

        function openQrModal() { qrModal.style.display = "block"; }
        function closeQrModal() { qrModal.style.display = "none"; }

        function ensureHtml5QrInstance() {
            if (!html5Qr) {
                html5Qr = new Html5Qrcode("qrReader");
            }
        }

        function startQRScanner(target) {
            qrTarget = target;
            openQrModal();
            qrStatus.textContent = "Iniciando cÃ¡mara...";
            ensureHtml5QrInstance();

            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            html5Qr.start({ facingMode: "environment" }, config,
                (decodedText) => {
                    const v = decodedText.trim();
                    handleQRValue(v);
                    qrStatus.textContent = `CÃ³digo leÃ­do: ${v}`;
                    html5Qr.stop().then(() => closeQrModal()).catch(err => {
                        console.error(err);
                        closeQrModal();
                    });
                },
                (err) => {
                    if (!err.toString().includes("NotFoundException")) {
                        qrStatus.textContent = "Buscando QR...";
                    }
                }
            ).then(() => {
                qrStatus.textContent = "Enfoca el cÃ³digo QR.";
            }).catch(err => {
                console.error(err);
                qrStatus.textContent = "No se pudo iniciar el escÃ¡ner.";
            });
        }

        function stopQRScanner() {
            if (html5Qr) {
                html5Qr.stop().catch(err => console.error("Error al detener escÃ¡ner:", err));
            }
            closeQrModal();
        }

        scanBulkQRBtn.addEventListener("click", () => startQRScanner("bulk"));

        function wireLocationQRButtons() {
            document.querySelectorAll(".qr-location-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const targetId = btn.dataset.qrTarget;
                    startQRScanner(targetId);
                });
            });
        }

        qrCloseBtn.addEventListener("click", stopQRScanner);

        // SincronizaciÃ³n masiva
        syncAllToCloudBtn.addEventListener("click", async () => {
            if (data2.length === 0) {
                alert("No hay datos en la tabla para sincronizar.");
                return;
            }

            const originalText = syncAllToCloudBtn.innerHTML;
            syncAllToCloudBtn.innerHTML = "<span>Enviando todo a la nube...</span>";
            syncAllToCloudBtn.disabled = true;

            try {
                await fetch(URLGOOGLE, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ masivo: true, datos: data2 })
                });

                syncAllToCloudBtn.innerHTML = "<span>Â¡Todo Sincronizado!</span>";
                syncAllToCloudBtn.classList.replace("bg-indigo-600", "bg-green-600");

                setTimeout(() => {
                    syncAllToCloudBtn.innerHTML = originalText;
                    syncAllToCloudBtn.classList.replace("bg-green-600", "bg-indigo-600");
                    syncAllToCloudBtn.disabled = false;
                }, 3000);
            } catch (error) {
                console.error("Error en envÃ­o masivo:", error);
                alert("Hubo un error de conexiÃ³n al intentar sincronizar.");
                syncAllToCloudBtn.innerHTML = originalText;
                syncAllToCloudBtn.disabled = false;
            }
        });

        // Detector de recuperaciÃ³n de Internet
        window.addEventListener("online", () => {
            if (localStorage.getItem("pendingsync") === "true" && data2.length > 0) {
                console.log("Internet detectado. Sincronizando pendientes...");
                syncToCloud(data2).then(success => {
                    if (success) {
                        localStorage.removeItem("pendingsync");
                        alert("Â¡ConexiÃ³n recuperada! Tus cambios se han sincronizado con Google Sheets.");
                    }
                });
            }
        });
    </script>
</body>
</html>
